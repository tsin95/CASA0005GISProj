---
title: "My Code and Outputs"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```
Hi! Welcome to where my work is :) 
You can scroll through chronologically, or skip to particular sections you are interested in from the navigation bar on the left - please give it a while to load then mouse-over it. 

# 1. Loading and joining data
Set working directory first


Loading required libraries
```{r}
library(sf)
library(rgdal)
library(raster)
library(mapview)
library(spatstat)
library(sp)
library(rgeos)
library(maptools)
library(GISTools)
library(tmap)
library(sf)
library(geojson)
library(geojsonio)
library(tmaptools)
```

Opening shapefile, taken from ukdataservice.ac.uk, giving a map of Greater Manchester by 2011 English Census Merged Wards (hence data for basemap shapefile is by ward level).
```{r}
require(rgdal)
require(ggplot2)
shp <- readOGR(dsn ="BoundaryData", layer="england_cmwd_2011", stringsAsFactors = F)
plot(shp)
```
```{r}
#checking Coordinate Reference System of the shapefile, which was originally NA
summary(shp)
crs(shp)
```

Specifying CRS of the greater manchester area shapefile as EPSG 4326 for latitude/longiture
```{r}
Manchester <- spTransform(shp, CRS("+init=epsg:4326"))
st_crs(Manchester)
```
Plot Manchester basemap

```{r}
plot(Manchester)
```

Extract just the city of Manchester itself rather than greater Manchester, as the area would otherwise be too big for analysis and Ripley's K. 
```{r}
#extract the city
cityManchester <- subset(Manchester, name %in% c("Didsbury West","Fallowfield","Gorton North","Gorton South","Harpurhey","Higher Blackley","Hulme","Levenshulme","Longsight","Miles Platting and Newton Heath","Moss Side","Moston","Northenden","Old Moat","Rusholme","Sharston","Whalley Range","Withington","Woodhouse Park","Ancoats and Clayton","Ardwick","Baguley","Bradford","Brooklands","Burnage","Charlestown","Cheetham","Chorlton","Chorlton Park","City Centre","Crumpsall","Didsbury East"))

#Check to see that the correct borough has been pulled out
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5)
```




Read in police station data for greater manchester area, from the geoJSON file obtained using overpass-turbo.eu API and running a query for police stations in the Greater Manchester Area from OpenStreetMap. 

Keeping only the points, as readOGR cannot read both points and polygons at the same time, and the points represent police stations.
```{r}
pol <- rgdal::readOGR("C:/Users/Tommy/Desktop/GIS_proj/BoundaryData/polstn.geojson",require_geomType="wkbPoint")
```

Plotting the police station points
```{r}
plot(pol)
summary(pol)
```

Checking the CRS of the police station points - it is already EPSG4326!
```{r}
st_crs(pol)
```
Removing duplicates from police station points

```{r}
polstns <- remove.duplicates(pol)
```

Plotting the police station points on top of the greater manchester area map using mapview
```{r}
mapview::mapview(Manchester) + mapview::mapview(polstns, color = "white", col.regions = "black",legend=FALSE)
```

Basemap of Manchester is a SpatialPolygonsDataFrame
Police station points is a SpatialPointsDataFrame
```{r}
class(cityManchester)
class(polstns)
```

Plot the police stations in the Greater Manchester area using tmap 
```{r}
tmap_mode("view")
tm_shape(Manchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polstns) +
  tm_dots(col = "blue")
```
Plot the police stations in the Manchester city area using tmap 
```{r}
tmap_mode("view")
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polstns) +
  tm_dots(col = "blue")
```

Filtering for police stations which are within the Manchester city boundary
```{r}
proj4string(cityManchester) <- CRS("+init=epsg:4326")
proj4string(polstns) <- CRS("+init=epsg:4326")

polsub <- polstns[cityManchester,]
#checking to see that they've been removed
tmap_mode("view")
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

Reading in the dataset for population density 

```{r}

library(readr)
popdens <- read_csv("popdens.csv")
summary(popdens)
```
Joining first dataset of population density with the Manchester basemap 
```{r}
require(sp)
?sp::merge
manchester_popdens <- merge(cityManchester, popdens, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to test if join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_popdens) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

Reading in the dataset for deprivation - the average number (out of 4 - employment, education, health and disability and household overcrowding) of dimensions a household was deprived in was used
```{r}
depr <- read_csv("deprivation.csv")
summary(depr)
```

Joining second dataset of deprivation with the Manchester basemap 
```{r}
manchester_2 <- merge(manchester_popdens, depr, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to check if second join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_2) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```
Reading in the dataset for SES - the average social grade by ward was taken, by using a numeric scale of AB = 1, C1 = 2, C2 = 3, DE = 4, so lower numbers would mean a higher social grade.
```{r}
ses <- read_csv("SES.csv")
summary(ses)
```
Joining third dataset of SES with the Manchester basemap 
```{r}
manchester_merged <- merge(manchester_2, ses, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to check if third join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_merged) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

manchester_merged is the map of Manchester city with merged data on population density, social grade and SES.

# 2. Plotting/performing KDE for crime data in Manchester city

Next step would be to map the crime datapoints onto the Manchester basemap. Crime data for June 2019 for the Greater Manchester area was used. This was taken from https://data.police.uk/data/ 




```{r}
crime <- read_csv("manchester_crime.csv")
crime_locations <- st_as_sf(crime, coords = c("Longitude","Latitude"), crs = 4326)
class(crime)
require(sf)
crime_sf <- st_as_sf(x = crime, 
                        coords = c("Longitude", "Latitude"),
                        crs = "+init=epsg:4326")
# simple plot
plot(crime_sf)

crime_spdf <- as(crime_sf, "Spatial")


manchester_crime_test<-ggplot(crime, aes(x=Longitude,y=Latitude))+geom_point()+coord_equal()
manchester_crime_test

```
Plotting a 2D KDE of crime occurences in Manchester using the longitude and latitude data in the crime dataset
```{r}
manchester_crime_test<-ggplot(crime, aes(x=Longitude,y=Latitude))+stat_bin2d(bins=30)
manchester_crime_test
```
Plotting a continuous distribution instead
```{r}
manchester_crime_test+stat_density2d(aes(fill = ..level..), geom="polygon")
```

Plotting the crime datapoints to test
```{r}
plot(crime_locations)
```

Examining metadata of the crime datapoints
```{r}
summary(crime_locations)
```

Checking CRS of crime datapoints
```{r}
crs(crime_locations)
```
Checking type of data of the crimem locations - sf, tbl_df, tbl, data.frame
```{r}
class(crime_locations)
```
Ensuring that crime_locations has EPSG 4326 as CRS
```{r}
crime_locations_sp <- as(crime_locations, 'Spatial')
crime_locations_sp <- spTransform(crime_locations_sp, CRS("+init=epsg:4326"))
```
Checking new CRS of crime datapoints and data type, removing duplicates
```{r}
crs(crime_locations)

```


```{r}
class(crime_locations)
```

Plotting crime data points on Manchester basemap
```{r}
mapview::mapview(manchester_merged) + mapview::mapview(crime_locations, color = "white", col.regions = "black",legend=FALSE, title = "Crime occurences in Manchester city")
```

# 3. Descriptive statistics for data
```{r}
library(tidyverse)
library(downloader)
library(rgdal)
library(sf)
library(ggplot2)
library(reshape2)
library(plotly)
library(highcharter)
```

Histograms for each of the scale variables - population densities, deprivation, and SES
Starting with popdens
```{r}
# Histogram with mean line (red) and median line (blue) and density plot
ggplot(popdens, aes(x=popdens)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth=10)+
 geom_density(alpha=.2, fill="#FF6666") + geom_vline(aes(xintercept=mean(popdens)),
            color="red", linetype="dashed", size=1) + geom_vline(aes(xintercept=median(popdens)),
            color="blue", linetype="dashed", size=1) 

# Descriptive statistics
print(max(popdens$popdens))
print(min(popdens$popdens))
print(median(popdens$popdens))
print(sd(popdens$popdens))
print(IQR(popdens$popdens))
print(quantile(popdens$popdens, c(.25, .75)))

```
Plotting histogram for deprivation next
```{r}
# Histogram with mean line (red) and median line (blue) and density plot
ggplot(depr, aes(x=deprivation)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth= 0.1)+
 geom_density(alpha=.2, fill="#FF6666") + geom_vline(aes(xintercept=mean(deprivation)),
            color="red", linetype="dashed", size=1) + geom_vline(aes(xintercept=median(deprivation)),
            color="blue", linetype="dashed", size=1) 

# Descriptive statistics
print(max(depr$deprivation))
print(min(depr$deprivation))
print(median(depr$deprivation))
print(sd(depr$deprivation))
print(IQR(depr$deprivation))
print(quantile(depr$deprivation, c(.25, .75)))
```
Plotting histogram for social grade next
```{r}
# Histogram with mean line (red) and median line (blue) and density plot
ggplot(ses, aes(x=socialgrade)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth= 0.1)+
 geom_density(alpha=.2, fill="#FF6666") + geom_vline(aes(xintercept=mean(socialgrade)),
            color="red", linetype="dashed", size=1) + geom_vline(aes(xintercept=median(socialgrade)),
            color="blue", linetype="dashed", size=1) 

# Descriptive statistics
print(max(ses$socialgrade))
print(min(ses$socialgrade))
print(median(ses$socialgrade))
print(sd(ses$socialgrade))
print(IQR(ses$socialgrade))
print(quantile(ses$socialgrade, c(.25, .75)))
```
Plotting histogram for crimes recorded per ward next
```{r}
#reading in data for crimes recorded per ward (taken from later part of the code after performing count)
library(readr)
crime_ward <- read_csv("crime_ward.csv")
summary(crime_ward)
crime_ward$lnCrime <- log1p(crime_ward$crimes)
# Histogram with mean line (red) and median line (blue) and density plot
ggplot(crime_ward, aes(x=lnCrime)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white", binwidth= 0.05)+
 geom_density(alpha=.2, fill="#FF6666") + geom_vline(aes(xintercept=mean(lnCrime)),
            color="red", linetype="dashed", size=1) + geom_vline(aes(xintercept=median(lnCrime)),
            color="blue", linetype="dashed", size=1) 

# Descriptive statistics
print(max(crime_ward$crimes))
print(min(crime_ward$crimes))
print(median(crime_ward$crimes))
print(sd(crime_ward$crimes))
print(IQR(crime_ward$crimes))
print(quantile(crime_ward$crimes, c(.25, .75)))
```

Converting both cityManchester and crime_locations to data.frames to run the KDE, since it requires numeric input
```{r}
df_cityManchester <- as.data.frame(cityManchester)
df_crime_locations <- as.data.frame(crime_locations)
```
Create two separate fields for latitude and longitude from the manchester spatialpolygonsdataframe 
```{r}                                                                                                                                                                
polys = attr(cityManchester,'polygons')
npolys = length(polys)
for (i in 1:npolys){
  poly = polys[[i]]
  polys2 = attr(poly,'Polygons')
  npolys2 = length(polys2)
  for (j in 1:npolys2){
     #do stuff with these values
     coords = coordinates(polys2[[j]])
     
  }
}
coords_df <- as.data.frame(coords)
```
Plotting out crime occurences in Manchestaer city
```{r}
ggplot() + geom_polygon(data = coords_df, aes(x = V1, y = V2), fill = "grey75") +
  geom_point(data = crime, aes(x = Longitude, y = Latitude),
             col = "dodger blue", alpha = .5, size = 1.5) +
  coord_equal() +
  ggtitle("Crime occurences in Manchester")
  
```


Counting number of crime occurence points per polygon
```{r}
class(manchester_merged)
class(crime_spdf)
proj4string(manchester_merged)

crime_spdf <- spTransform(crime_spdf, CRS("+init=epsg:4326"))
proj4string(crime_spdf)
plot(manchester_merged)
plot(crime_spdf, col="red" , add=TRUE)
res <- over(crime_spdf, manchester_merged)
table(res$name)
```
After plotting number of crimes per ward on a .csv file, time to merge with the manchester_merged basemap.
Reading in the dataset for crimes per ward using code chunk directly above
```{r}
summary(crime_ward)
```
Joining crimes per ward dataset with the Manchester basemap 
```{r}
manchester_merged_final <- merge(x= manchester_merged, y=crime_ward, by.x = "name", by.y = "geography")
```

Plotting map to check if join has succeeded. 
```{r}
library(tmap)
tmap_mode("view")
tm_shape(manchester_merged_final) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```
All data (popdens, social grade, SES, crime) on ward level loaded, locations of 4 police stations in Manchester city also loaded. 

# 4. Choropleth maps by variables across Manchester

Making a choropleth map by crimes
```{r}
library(ggplot2)
library(RColorBrewer)
library(classInt)
names(manchester_merged_final)
#spplot(manchester_merged_final, "crimes")
# quantile breaks
breaks_qt <- classIntervals(manchester_merged_final$crimes, n = 7, style = "quantile")
br <- breaks_qt$brks 
offs <- 0.0000001 
br[1] <- br[1] - offs 
br[length(br)] <- br[length(br)] + offs 
# categories for choropleth map
manchester_merged_final$crimes_bracket <- cut(manchester_merged_final$crimes, br)
# plot
#my.palette <- brewer.pal(n = 7, name = "OrRd")
#spplot(manchester_merged_final, "crimes_bracket", col.regions=my.palette, main = "Manchester City Recorded Crimes in June 2019 by Ward")

#Using tmap
library(tmap)
tm_shape(manchester_merged_final) +
  tm_polygons("crimes", 
              style="quantile", 
              title="Manchester city \nrecorded crimes \nby ward in June 2019")
tmap_mode("view")
```
Making a choropleth map by popdens
```{r}
# quantile breaks
breaks_qt <- classIntervals(manchester_merged_final$popdens, n = 7, style = "quantile")
br <- breaks_qt$brks 
offs <- 0.0000001 
br[1] <- br[1] - offs 
br[length(br)] <- br[length(br)] + offs 

# categories for choropleth map
manchester_merged_final$popdens_bracket <- cut(manchester_merged_final$popdens, br)
# plot
#spplot(manchester_merged_final, "popdens_bracket", col.regions=my.palette, main = "Manchester City Population Density by Ward")

#Using tmap
library(tmap)
tm_shape(manchester_merged_final) +
  tm_polygons("popdens", 
              style="quantile", 
              title="Manchester city \nPopulation Density \nby ward")
tmap_mode("view")
```

Making a choropleth map by deprivation
```{r}
#spplot(manchester_merged_final, "deprivation")
breaks_qt <- classIntervals(manchester_merged_final$deprivation, n = 7, style = "quantile")
br <- breaks_qt$brks 
offs <- 0.0000001 
br[1] <- br[1] - offs 
br[length(br)] <- br[length(br)] + offs 
# categories for choropleth map
manchester_merged_final$deprivation_bracket <- cut(manchester_merged_final$deprivation, br)
# plot

#spplot(manchester_merged_final, "deprivation_bracket", col.regions=my.palette, main = "Manchester City deprivation by Ward")
#Using tmap
library(tmap)
tm_shape(manchester_merged_final) +
  tm_polygons("deprivation", 
              style="quantile", 
              title="Manchester city \ndeprivation \nby ward")
tmap_mode("view")
```

Making a choropleth map by social grade
```{r}
#spplot(manchester_merged_final, "socialgrade")
breaks_qt <- classIntervals(manchester_merged_final$socialgrade, n = 7, style = "quantile")
br <- breaks_qt$brks 
offs <- 0.0000001 
br[1] <- br[1] - offs 
br[length(br)] <- br[length(br)] + offs 
# categories for choropleth map
manchester_merged_final$socialgrade_bracket <- cut(manchester_merged_final$socialgrade, br)
# plot
#spplot(manchester_merged_final, "socialgrade_bracket", col.regions=my.palette, main = "Manchester City social grade by Ward")
#Using tmap
library(tmap)
tm_shape(manchester_merged_final) +
  tm_polygons("socialgrade", 
              style="quantile", 
              title="Manchester city \nsocial grade \nby ward")
tmap_mode("view")
```
