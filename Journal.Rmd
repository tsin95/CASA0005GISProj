---
title: "My Code and Outputs"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```
Hi! Welcome to where my work is :) 
You can scroll through chronologically, or skip to particular sections you are interested in from the navigation bar on the left - please give it a while to load then mouse-over it. 

# 1. Loading and joining data
Set working directory first


Loading required libraries
```{r}
library(sf)
library(rgdal)
library(raster)
library(mapview)
library(spatstat)
library(sp)
library(rgeos)
library(maptools)
library(GISTools)
library(tmap)
library(sf)
library(geojson)
library(geojsonio)
library(tmaptools)
```

Opening shapefile, taken from ukdataservice.ac.uk, giving a map of Greater Manchester by 2011 English Census Merged Wards (hence data for basemap shapefile is by ward level).
```{r}
require(rgdal)
require(ggplot2)
shp <- readOGR(dsn ="BoundaryData", layer="england_cmwd_2011", stringsAsFactors = F)
plot(shp)
```
```{r}
#checking Coordinate Reference System of the shapefile, which was originally NA
summary(shp)
crs(shp)
```

Specifying CRS of the greater manchester area shapefile as EPSG 4326 for latitude/longiture
```{r}
Manchester <- spTransform(shp, CRS("+init=epsg:4326"))
st_crs(Manchester)
```
Plot Manchester basemap

```{r}
plot(Manchester)
```

Extract just the city of Manchester itself rather than greater Manchester, as the area would otherwise be too big for analysis and Ripley's K. 
```{r}
#extract the city
cityManchester <- subset(Manchester, name %in% c("Didsbury West","Fallowfield","Gorton North","Gorton South","Harpurhey","Higher Blackley","Hulme","Levenshulme","Longsight","Miles Platting and Newton Heath","Moss Side","Moston","Northenden","Old Moat","Rusholme","Sharston","Whalley Range","Withington","Woodhouse Park","Ancoats and Clayton","Ardwick","Baguley","Bradford","Brooklands","Burnage","Charlestown","Cheetham","Chorlton","Chorlton Park","City Centre","Crumpsall","Didsbury East"))

#Check to see that the correct borough has been pulled out
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5)
```




Read in police station data for greater manchester area, from the geoJSON file obtained using overpass-turbo.eu API and running a query for police stations in the Greater Manchester Area from OpenStreetMap. 

Keeping only the points, as readOGR cannot read both points and polygons at the same time, and the points represent police stations.
```{r}
pol <- rgdal::readOGR("C:/Users/Tommy/Desktop/GIS_proj/BoundaryData/polstn.geojson",require_geomType="wkbPoint")
```

Plotting the police station points
```{r}
plot(pol)
summary(pol)
```

Checking the CRS of the police station points - it is already EPSG4326!
```{r}
st_crs(pol)
```
Removing duplicates from police station points

```{r}
polstns <- remove.duplicates(pol)
```

Plotting the police station points on top of the greater manchester area map using mapview
```{r}
mapview::mapview(Manchester) + mapview::mapview(polstns, color = "white", col.regions = "black",legend=FALSE)
```

Basemap of Manchester is a SpatialPolygonsDataFrame
Police station points is a SpatialPointsDataFrame
```{r}
class(cityManchester)
class(polstns)
```

Plot the police stations in the Greater Manchester area using tmap 
```{r}
tmap_mode("view")
tm_shape(Manchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polstns) +
  tm_dots(col = "blue")
```
Plot the police stations in the Manchester city area using tmap 
```{r}
tmap_mode("view")
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polstns) +
  tm_dots(col = "blue")
```

Filtering for police stations which are within the Manchester city boundary
```{r}
proj4string(cityManchester) <- CRS("+init=epsg:4326")
proj4string(polstns) <- CRS("+init=epsg:4326")

polsub <- polstns[cityManchester,]
#checking to see that they've been removed
tmap_mode("view")
tm_shape(cityManchester) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

Reading in the dataset for population density 

```{r}

library(readr)
popdens <- read_csv("popdens.csv")
summary(popdens)
```
Joining first dataset of population density with the Manchester basemap 
```{r}
require(sp)
?sp::merge
manchester_popdens <- merge(cityManchester, popdens, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to test if join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_popdens) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

Reading in the dataset for deprivation - the average number (out of 4 - employment, education, health and disability and household overcrowding) of dimensions a household was deprived in was used
```{r}
depr <- read_csv("deprivation.csv")
summary(depr)
```

Joining second dataset of deprivation with the Manchester basemap 
```{r}
manchester_2 <- merge(manchester_popdens, depr, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to check if second join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_2) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```
Reading in the dataset for SES - the average social grade by ward was taken, by using a numeric scale of AB = 1, C1 = 2, C2 = 3, DE = 4, so lower numbers would mean a higher social grade.
```{r}
ses <- read_csv("SES.csv")
summary(ses)
```
Joining third dataset of SES with the Manchester basemap 
```{r}
manchester_merged <- merge(manchester_2, ses, by.x = "name", by.y = "geography",duplicateGeoms = TRUE)
```

Plotting map to check if third join has succeeded
```{r}
tmap_mode("view")
tm_shape(manchester_merged) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(polsub) +
  tm_dots(col = "blue")
```

manchester_merged is the map of Manchester city with merged data on population density, social grade and SES.

